<!DOCTYPE html>
<html lang="de">

<head>
  <title>x-mal Mathe</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
    }

    html,
    body {
      width: 100vw;
      height: 100vh;
      padding: 0;
      margin: 0;
    }

    body {
      display: grid;
      grid-template-columns: minmax(min-content, 1024px);
      justify-content: center;
      grid-template-rows: /* min-content min-content */ min-content 1fr min-content;
      overflow: hidden;
    }

    div {
      border: 1px solid red;
      scroll-snap-align: center;
      scroll-snap-stop: always;
      overflow-y: auto;
    }

    main {
      display: grid;
      grid-auto-flow: column;
      grid-auto-columns: 100%;
      grid-template-rows: 1fr;
      overflow-x: scroll;
      scroll-snap-type: x mandatory;
      scroll-behavior: smooth;
      border: 1px solid transparent;
      border-width: 0 1px;
    }

    nav, footer {
      height: 48px;
    }

    ul {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;flex-direction: row;
    }

    li {
      flex: auto;
      }
  </style>
  <script src="main.js"></script>

  <template>
    <article class="wall target" data-a="rand(1,10)" data-b="a+((a>5)?10:-10)" style="position: relative">
      <section class="animation" data-from="opacity=0" data-to="opacity=1" data-at="opacity=1&offset=.1">
        <header>
          <h1 class="animation" data-from="left=200px" data-to="left=100px" data-at="left=50px&offset=0.2"
            style="left: 200px;position: relative; display: inline-block">
            Frage</h1>
          <a href="#c">C</a>
          <p style="display: block; height: 200px; outline: 2px solid green">text <span class="data"
              data-value="b+2">NIX</span></p>
              <a href="#b">B</a>
        </header>
      </section>
      <section>
        <header>
          <h1>Antwort</h1>
          <p style="display: block; height: 500px; outline: 2px solid green">text</p>
          <a href="#a">A</a>
        </header>
      </section>
    </article>
  </template>
</head>

<body>
<nav>
  header
</nav>
  <main>
    <div id="start">
      <p id="a">A Lorem ipsum dolor sit amet consectetur adipisicing elit. Ea quis, alias culpa cumque impedit sit accusantium asperiores? Sint quasi ut quam ducimus repellat quibusdam. Quaerat, amet doloribus. Ratione, vero tenetur? </p>
      <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Ea quis, alias culpa cumque impedit sit accusantium asperiores? Sint quasi ut quam ducimus repellat quibusdam. Quaerat, amet doloribus. Ratione, vero tenetur? </p>
      <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Ea quis, alias culpa cumque impedit sit accusantium asperiores? Sint quasi ut quam ducimus repellat quibusdam. Quaerat, amet doloribus. Ratione, vero tenetur? </p>
      <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Ea quis, alias culpa cumque impedit sit accusantium asperiores? Sint quasi ut quam ducimus repellat quibusdam. Quaerat, amet doloribus. Ratione, vero tenetur? </p>
      <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Ea quis, alias culpa cumque impedit sit accusantium asperiores? Sint quasi ut quam ducimus repellat quibusdam. Quaerat, amet doloribus. Ratione, vero tenetur? </p>
      <p id="c">C Lorem ipsum dolor sit amet consectetur adipisicing elit. Ea quis, alias culpa cumque impedit sit accusantium asperiores? Sint quasi ut quam ducimus repellat quibusdam. Quaerat, amet doloribus. Ratione, vero tenetur? </p>
      <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Ea quis, alias culpa cumque impedit sit accusantium asperiores? Sint quasi ut quam ducimus repellat quibusdam. Quaerat, amet doloribus. Ratione, vero tenetur? </p>
      <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Ea quis, alias culpa cumque impedit sit accusantium asperiores? Sint quasi ut quam ducimus repellat quibusdam. Quaerat, amet doloribus. Ratione, vero tenetur? </p>
      <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Ea quis, alias culpa cumque impedit sit accusantium asperiores? Sint quasi ut quam ducimus repellat quibusdam. Quaerat, amet doloribus. Ratione, vero tenetur? </p>
      <p id="b">B Lorem ipsum dolor sit amet consectetur adipisicing elit. Ea quis, alias culpa cumque impedit sit accusantium asperiores? Sint quasi ut quam ducimus repellat quibusdam. Quaerat, amet doloribus. Ratione, vero tenetur? </p>
    </div>
    <div id="main"></div>
  </main>
<footer>
  <ul>
    <li><a href="#start">start</a></li>
    <li><a href="#main">main</a></li>
</ul>
</body>
<script>

  const rand = (from, to, step = 1) => { return Math.floor(Math.random() * ((to + 1 - from) / step)) * step + from; }

  const main = document.querySelector('#main');
  const templates = document.querySelectorAll('template');

  const intersection = new IntersectionObserver((entries, self) => {
    entries.forEach((entry) => {
      if (entry.target.classList.contains('wall')) {
        if (entry.isIntersecting && (main.lastElementChild === entry.target)) {
          main.append(templates.random().content.firstElementChild.cloneNode(true));
        }
        if (entry.boundingClientRect.bottom < 0 && (entry.target.previousElementSibling === main.firstElementChild)) {
          main.firstElementChild.remove()
        }
      }
      if (entry.isIntersecting) {
        for (let e of document.querySelectorAll(`[data-target=${entry.target.id}]`)) {
          if (e.animation) {
            e.animation.currentTime = entry.intersectionRatio * 1000;
          }
        }
      }
    });
  }, {
    rootMargin: "100% 0px 0px 0px",
    root: main,
    threshold: Array.from(Array(1001)).map((e, i) => i * .001)
  });

  const mutation = new MutationObserver((entries, self) => {
    entries.forEach((entry) => {
      Array.from(entry.addedNodes).forEach((addedNode) => {
        let dataset = Object.assign({}, addedNode.dataset);
        let env = Object.create({});
        addedNode.id = `added${Date.now()}`;

        for (let [key, value] of Object.entries(dataset)) {
          Object.defineProperty(env, key, {
            value: new Function(...Object.keys(env), `return ${value}`)(...Object.values(env)),
            enumerable: true
          })
        }

        addedNode.querySelectorAll('.data').forEach((node) => {
          node.textContent = new Function(...Object.keys(env), `return ${node.dataset.value}`)(...Object.values(env))
        });

        addedNode.querySelectorAll('.animation').forEach((node) => {

          node.dataset.target = addedNode.id;
          node.animation = node.animate([
            new URLSearchParams(node.dataset.from),
            new URLSearchParams(node.dataset.at),
            new URLSearchParams(node.dataset.to)
          ].map(entry => {
            return Object.fromEntries(entry.entries())
          }), 1010);
          node.animation.currentTime = 1;
          node.animation.pause();
        });

        intersection.observe(addedNode);
      });

      Array.from(entry.removedNodes).forEach((removed) => {
        intersection.unobserve(removed);
      });
    });
  });

  mutation.observe(main, {
    childList: true,
    subtree: false
  })

  main.append(templates.random().content.firstElementChild.cloneNode(true));
</script>

</html>